<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Principale | 選手詳細</title>
  <link rel="icon" href="images/logo/Principale.png" type="image/png">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
</head>
<body class="bg-gray-50" style="font-family: 'Noto Sans JP', sans-serif;">

  <!-- ヘッダー -->
  <div id="header" class="pt-24"></div>

  <main>
    <section class="text-gray-600 body-font">
      <div class="container max-w-full px-5 py-24 mx-auto">

        <h1 class="sm:text-3xl text-2xl font-black title-font mb-6 text-gray-900 text-center">
          PLAYER DETAIL
        </h1>

        <!-- 選手詳細表示 -->
        <div id="player-detail" class="max-w-[75%] mx-auto"></div>

        <!-- 戻るボタン -->
        <div class="text-center mt-8">
          <button onclick="history.back()" class="inline-block bg-[#72bce6] text-white px-6 py-2 rounded font-bold hover:bg-[#5aa8d1] transition-colors duration-200">
            BACK
          </button>
        </div>

      </div>
    </section>
  </main>

  <!-- フッター -->
  <div id="footer" class="pt-4"></div>

<script>
// ヘッダーとフッター読み込み
fetch('header.html').then(r => r.text()).then(html => document.getElementById('header').innerHTML = html);
fetch('footer.html').then(r => r.text()).then(html => document.getElementById('footer').innerHTML = html);

// URLパラメータ取得
const params = new URLSearchParams(window.location.search);
const playerId = params.get('id');

Promise.all([
  fetch('data/players.json').then(r => r.json()),
  fetch('data/matches.json').then(r => r.json())
])
.then(([players, matches]) => {
  const player = players.find(p => p.psid === playerId);
  const container = document.getElementById('player-detail');
  if (!player) {
    container.innerHTML = "<p class='text-center'>選手が見つかりません。</p>";
    return;
  }

  // 集計
  let matchCount = 0, goals = 0, assists = 0;
  let firstMatch = null, firstGoal = null, firstAssist = null;
  let bestRating = null;
  const positionCount = {};
  const positionMap = {
    'LCB':'CB','RCB':'CB','LB':'SB','RB':'SB','LWB':'SB','RWB':'SB',
    'LDM':'CDM','RDM':'CDM','LCM':'CM','RCM':'CM','LAM':'SH','RAM':'SH',
    'LM':'SH','RM':'SH','LW':'WG','RW':'WG','LF':'CF','RF':'CF','LS':'ST','RS':'ST'
  };

  matches.slice().reverse().forEach(match => {
    match.home.players.concat(match.away.players).forEach(p => {
      if (p.name === player.psid) {
        matchCount++;
        goals += p.goals || 0;
        assists += p.assists || 0;

        const pos = positionMap[p.position || player.position] || (p.position || player.position);
        positionCount[pos] = (positionCount[pos] || 0) + 1;

        if (!firstMatch) firstMatch = match;
        if (p.goals > 0 && !firstGoal) firstGoal = match;
        if (p.assists > 0 && !firstAssist) firstAssist = match;
        if (!bestRating || p.rating > bestRating.p.rating) bestRating = { p, match };
      }
    });
  });

  function matchLabel(match) { return `${match.date}（${match.tournament} ${match.round}）`; }
  function bestRatingValue(br) { return `${br.p.rating.toFixed(1)}（${br.p.position}）`; }
  function bestRatingDate(br) { return `${br.match.date}（${br.match.tournament} ${br.match.round}）`; }

  // HTML生成
  container.innerHTML = `
    <div class="flex flex-col md:flex-row gap-10">
      <!-- 左：画像 + ポジションチャート -->
      <div class="flex flex-col items-center md:w-1/3 gap-4">
        <img src="${player.image}" alt="${player.name}" class="w-40 h-40 rounded-full object-cover shadow">
        <h3 class="font-semibold text-lg">出場ポジション比率</h3>
        <div class="w-48 h-48">
          <canvas id="positionChart"></canvas>
        </div>
      </div>

      <!-- 右：選手情報テーブル -->
      <div class="md:w-2/3">
        <table class="table-auto w-full border-collapse border border-gray-200 text-left text-sm">
          <tbody>
            <tr class="bg-gray-100"><td class="border px-3 py-1 font-bold w-32">名前</td><td class="border px-3 py-1">${player.name}</td></tr>
            <tr><td class="border px-3 py-1 font-bold">ポジション</td><td class="border px-3 py-1">${player.position}</td></tr>
            <tr class="bg-gray-100"><td class="border px-3 py-1 font-bold">背番号</td><td class="border px-3 py-1">${player.number}</td></tr>
            <tr><td class="border px-3 py-1 font-bold">PSID</td><td class="border px-3 py-1">${player.psid}</td></tr>
            <tr class="bg-gray-100"><td class="border px-3 py-1 font-bold">初出場日</td><td class="border px-3 py-1">${firstMatch ? matchLabel(firstMatch) : "出場無し"}</td></tr>
            <tr><td class="border px-3 py-1 font-bold">出場数</td><td class="border px-3 py-1">${matchCount}</td></tr>
            <tr class="bg-gray-100"><td class="border px-3 py-1 font-bold">最高評価点</td><td class="border px-3 py-1">${bestRating ? bestRatingValue(bestRating) : "なし"}</td></tr>
            <tr><td class="border px-3 py-1 font-bold">最高評価点日</td><td class="border px-3 py-1">${bestRating ? bestRatingDate(bestRating) : "出場無し"}</td></tr>
            <tr class="bg-gray-100"><td class="border px-3 py-1 font-bold">初得点日</td><td class="border px-3 py-1">${firstGoal ? matchLabel(firstGoal) : "得点無し"}</td></tr>
            <tr><td class="border px-3 py-1 font-bold">得点数</td><td class="border px-3 py-1">${goals}</td></tr>
            <tr class="bg-gray-100"><td class="border px-3 py-1 font-bold">初アシスト日</td><td class="border px-3 py-1">${firstAssist ? matchLabel(firstAssist) : "アシスト無し"}</td></tr>
            <tr><td class="border px-3 py-1 font-bold">アシスト数</td><td class="border px-3 py-1">${assists}</td></tr>
            <tr class="bg-gray-100"><td class="border px-3 py-1 font-bold">加入日</td><td class="border px-3 py-1">${player.joinDate || "不明"}</td></tr>
            <tr><td class="border px-3 py-1 font-bold">前所属</td><td class="border px-3 py-1">${player.previousTeam || "不明"}</td></tr>
            ${player.outDate ? `<tr class="bg-gray-100"><td class="border px-3 py-1 font-bold">退団日</td><td class="border px-3 py-1">${player.outDate}</td></tr>` : ''}
          </tbody>
        </table>
      </div>
    </div>
  `;

  // Chart.js 初期化
  const sortedPositions = Object.entries(positionCount).sort((a,b)=>b[1]-a[1]);
  const labels = sortedPositions.map(e=>e[0]);
  const data = sortedPositions.map(e=>e[1]);

  new Chart(document.getElementById('positionChart'), {
    type:'pie',
    data:{
      labels:labels,
      datasets:[{
        data:data,
        backgroundColor:['#FF6384','#36A2EB','#FFCE56','#4BC0C0','#9966FF','#FF9F40','#C9CBCF']
      }]
    },
    options:{
      responsive:true,
      plugins:{
        legend:{position:'bottom', labels:{boxWidth:12, padding:10}},
        datalabels:{color:'#fff', formatter:v=>v, font:{weight:'bold', size:12}}
      }
    },
    plugins:[ChartDataLabels]
  });

})
.catch(err => {
  console.error('選手情報読み込みエラー:', err);
  document.getElementById('player-detail').innerHTML = "<p class='text-center'>選手情報読み込みに失敗しました。</p>";
});
</script>
</body>
</html>
